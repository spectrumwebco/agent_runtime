# Prometheus configuration for {{project_name}}
# Generated by Rumble

global:
  scrape_interval: {{#scrape_interval}}{{.}}{{/scrape_interval}}{{^scrape_interval}}15s{{/scrape_interval}}
  evaluation_interval: {{#evaluation_interval}}{{.}}{{/evaluation_interval}}{{^evaluation_interval}}15s{{/evaluation_interval}}
  scrape_timeout: {{#scrape_timeout}}{{.}}{{/scrape_timeout}}{{^scrape_timeout}}10s{{/scrape_timeout}}

  # Attach labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    monitor: '{{#monitor_label}}{{.}}{{/monitor_label}}{{^monitor_label}}{{project_name}}-monitor{{/monitor_label}}'
    environment: '{{#environment}}{{.}}{{/environment}}{{^environment}}production{{/environment}}'

# Alertmanager configuration
{{#alertmanager}}
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      {{#targets}}
      - {{.}}
      {{/targets}}
      {{^targets}}
      - alertmanager:9093
      {{/targets}}
    {{#scheme}}
    scheme: {{.}}
    {{/scheme}}
    {{#timeout}}
    timeout: {{.}}
    {{/timeout}}
    {{#api_version}}
    api_version: {{.}}
    {{/api_version}}
{{/alertmanager}}

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
{{#rule_files}}
rule_files:
  {{#files}}
  - {{.}}
  {{/files}}
{{/rule_files}}
{{^rule_files}}
rule_files:
  - "rules/*.yml"
{{/rule_files}}

# A scrape configuration containing exactly one endpoint to scrape:
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Application metrics
  - job_name: '{{project_name}}'
    {{#metrics_path}}
    metrics_path: {{.}}
    {{/metrics_path}}
    {{^metrics_path}}
    metrics_path: /metrics
    {{/metrics_path}}
    {{#scheme}}
    scheme: {{.}}
    {{/scheme}}
    {{#scrape_interval_override}}
    scrape_interval: {{.}}
    {{/scrape_interval_override}}
    {{#sample_limit}}
    sample_limit: {{.}}
    {{/sample_limit}}
    static_configs:
      - targets:
        {{#app_targets}}
        - {{.}}
        {{/app_targets}}
        {{^app_targets}}
        - '{{project_name}}:8080'
        {{/app_targets}}
        labels:
          {{#static_labels}}
          {{key}}: {{value}}
          {{/static_labels}}
          {{^static_labels}}
          service: '{{project_name}}'
          {{/static_labels}}

  {{#node_exporter}}
  # Node Exporter metrics
  - job_name: 'node'
    static_configs:
      - targets:
        {{#node_targets}}
        - {{.}}
        {{/node_targets}}
        {{^node_targets}}
        - 'node-exporter:9100'
        {{/node_targets}}
  {{/node_exporter}}

  {{#cadvisor}}
  # cAdvisor metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets:
        {{#cadvisor_targets}}
        - {{.}}
        {{/cadvisor_targets}}
        {{^cadvisor_targets}}
        - 'cadvisor:8080'
        {{/cadvisor_targets}}
  {{/cadvisor}}

  {{#kubernetes}}
  # Kubernetes API Server metrics
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

  # Kubernetes Nodes metrics
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics

  # Kubernetes Pods metrics
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
  {{/kubernetes}}

  {{#custom_jobs}}
  # Custom job: {{name}}
  - job_name: '{{name}}'
    {{#metrics_path}}
    metrics_path: {{.}}
    {{/metrics_path}}
    {{#scheme}}
    scheme: {{.}}
    {{/scheme}}
    {{#scrape_interval}}
    scrape_interval: {{.}}
    {{/scrape_interval}}
    {{#static_configs}}
    static_configs:
      - targets:
        {{#targets}}
        - {{.}}
        {{/targets}}
        {{#labels}}
        labels:
          {{#label_pairs}}
          {{key}}: {{value}}
          {{/label_pairs}}
        {{/labels}}
    {{/static_configs}}
    {{#file_sd_configs}}
    file_sd_configs:
      - files:
        {{#files}}
        - {{.}}
        {{/files}}
        {{#refresh_interval}}
        refresh_interval: {{.}}
        {{/refresh_interval}}
    {{/file_sd_configs}}
    {{#kubernetes_sd_configs}}
    kubernetes_sd_configs:
      - role: {{role}}
        {{#api_server}}
        api_server: {{.}}
        {{/api_server}}
        {{#namespaces}}
        namespaces:
          names:
          {{#names}}
          - {{.}}
          {{/names}}
        {{/namespaces}}
    {{/kubernetes_sd_configs}}
    {{#relabel_configs}}
    relabel_configs:
      {{#relabel_rules}}
      - source_labels: {{source_labels}}
        {{#target_label}}
        target_label: {{.}}
        {{/target_label}}
        {{#regex}}
        regex: {{.}}
        {{/regex}}
        {{#replacement}}
        replacement: {{.}}
        {{/replacement}}
        {{#action}}
        action: {{.}}
        {{/action}}
      {{/relabel_rules}}
    {{/relabel_configs}}
    {{#metric_relabel_configs}}
    metric_relabel_configs:
      {{#relabel_rules}}
      - source_labels: {{source_labels}}
        {{#target_label}}
        target_label: {{.}}
        {{/target_label}}
        {{#regex}}
        regex: {{.}}
        {{/regex}}
        {{#replacement}}
        replacement: {{.}}
        {{/replacement}}
        {{#action}}
        action: {{.}}
        {{/action}}
      {{/relabel_rules}}
    {{/metric_relabel_configs}}
  {{/custom_jobs}}

{{#remote_write}}
remote_write:
  {{#remote_endpoints}}
  - url: {{url}}
    {{#remote_timeout}}
    remote_timeout: {{.}}
    {{/remote_timeout}}
    {{#write_relabel_configs}}
    write_relabel_configs:
      {{#relabel_rules}}
      - source_labels: {{source_labels}}
        {{#target_label}}
        target_label: {{.}}
        {{/target_label}}
        {{#regex}}
        regex: {{.}}
        {{/regex}}
        {{#replacement}}
        replacement: {{.}}
        {{/replacement}}
        {{#action}}
        action: {{.}}
        {{/action}}
      {{/relabel_rules}}
    {{/write_relabel_configs}}
    {{#basic_auth}}
    basic_auth:
      username: {{username}}
      password: {{password}}
    {{/basic_auth}}
    {{#bearer_token}}
    bearer_token: {{.}}
    {{/bearer_token}}
    {{#tls_config}}
    tls_config:
      {{#ca_file}}
      ca_file: {{.}}
      {{/ca_file}}
      {{#cert_file}}
      cert_file: {{.}}
      {{/cert_file}}
      {{#key_file}}
      key_file: {{.}}
      {{/key_file}}
      {{#insecure_skip_verify}}
      insecure_skip_verify: {{.}}
      {{/insecure_skip_verify}}
    {{/tls_config}}
  {{/remote_endpoints}}
{{/remote_write}}

{{#remote_read}}
remote_read:
  {{#remote_endpoints}}
  - url: {{url}}
    {{#read_recent}}
    read_recent: {{.}}
    {{/read_recent}}
    {{#remote_timeout}}
    remote_timeout: {{.}}
    {{/remote_timeout}}
    {{#basic_auth}}
    basic_auth:
      username: {{username}}
      password: {{password}}
    {{/basic_auth}}
    {{#bearer_token}}
    bearer_token: {{.}}
    {{/bearer_token}}
    {{#tls_config}}
    tls_config:
      {{#ca_file}}
      ca_file: {{.}}
      {{/ca_file}}
      {{#cert_file}}
      cert_file: {{.}}
      {{/cert_file}}
      {{#key_file}}
      key_file: {{.}}
      {{/key_file}}
      {{#insecure_skip_verify}}
      insecure_skip_verify: {{.}}
      {{/insecure_skip_verify}}
    {{/tls_config}}
  {{/remote_endpoints}}
{{/remote_read}}

{{#storage}}
storage:
  {{#tsdb}}
  tsdb:
    {{#retention_time}}
    retention.time: {{.}}
    {{/retention_time}}
    {{#retention_size}}
    retention.size: {{.}}
    {{/retention_size}}
    {{#min_block_duration}}
    min_block_duration: {{.}}
    {{/min_block_duration}}
    {{#max_block_duration}}
    max_block_duration: {{.}}
    {{/max_block_duration}}
    {{#no_lockfile}}
    no_lockfile: {{.}}
    {{/no_lockfile}}
    {{#allow_overlapping_blocks}}
    allow_overlapping_blocks: {{.}}
    {{/allow_overlapping_blocks}}
    {{#wal_compression}}
    wal_compression: {{.}}
    {{/wal_compression}}
  {{/tsdb}}
{{/storage}}

{{#tracing}}
tracing:
  {{#endpoint}}
  endpoint: {{.}}
  {{/endpoint}}
  {{#sampling_fraction}}
  sampling_fraction: {{.}}
  {{/sampling_fraction}}
  {{#insecure}}
  insecure: {{.}}
  {{/insecure}}
{{/tracing}}
